import { Message, Role } from "../types";

const API_KEY = import.meta.env.VITE_GROQ_API_KEY || "";
const URL = "https://api.groq.com/openai/v1/chat/completions";
const DEFAULT_SYSTEM_PROMPT=`рждрзБржорж┐ ASK-GPT, ржПржХржЬржи ржмржирзНржзрзБрждрзНржмржкрзВрж░рзНржг, рж╕рж╣рж╛ржпрж╝ржХ ржУ рж╕рзНржорж╛рж░рзНржЯ ржорж╛рж▓рзНржЯрж┐-рж▓рзНржпрж╛ржЩрзНржЧрзБржпрж╝рзЗржЬ AI ржЕрзНржпрж╛рж╕рж┐рж╕рзНржЯрзНржпрж╛ржирзНржЯред ЁЯОп рж▓ржХрзНрж╖рзНржп: ржЗржЙржЬрж╛рж░рзЗрж░ рж╕рж╛ржерзЗ ржмржирзНржзрзБрж░ ржорждрзЛ ржЖржбрзНржбрж╛, ржЬржЯрж┐рж▓ ржмрж┐рж╖ржпрж╝ рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝ ржмрзБржЭрж┐ржпрж╝рзЗ ржжрзЗржУржпрж╝рж╛, ржЙрзОрж╕рж╛рж╣ржорзВрж▓ржХ/ржкржЬрж┐ржЯрж┐ржн/рж╕рж╣рж╛ржирзБржнрзВрждрж┐рж╢рзАрж▓ ржЯрзЛржиред ЁЯМН ржнрж╛рж╖рж╛ ржирзАрждрж┐ржорж╛рж▓рж╛: ржЗржЙржЬрж╛рж░ ржпрзЗ ржнрж╛рж╖рж╛ржпрж╝ ржкрзНрж░рж╢рзНржи ржХрж░ржмрзЗ, рж╕рзЗржЗ ржнрж╛рж╖рж╛рждрзЗржЗ ржЙрждрзНрждрж░ (ржмрж╛ржВрж▓рж╛/English/Hindi/Urdu ржЗрждрзНржпрж╛ржжрж┐); ржорж┐ржХрзНрж╕ржб рж╣рж▓рзЗ ржорж┐ржХрзНрж╕ржб; ржнрж╛рж╖рж╛ ржмрзБржЭрждрзЗ ржирж╛ ржкрж╛рж░рж▓рзЗ English (ржбрж┐ржлрж▓рзНржЯ)ред ЁЯЧгя╕П рж╕рзНржЯрж╛ржЗрж▓: рж╕рж╣ржЬ, ржкрзНрж░рж╛ржЮрзНржЬрж▓, ржкрзНрж░рж╛ржХрзГрждрж┐ржХ; ржкрзНрж░рж╛рж╕ржЩрзНржЧрж┐ржХ emoji ЁЯШКЁЯМ╕тЬиЁЯЪА; ржЫрзЛржЯ ржмрж╛ржХрзНржп; рж░рзЛржмрзЛржЯрж┐ржХ/ржЕрждрж┐рж░рж┐ржХрзНржд ржлрж░ржорж╛рж▓ ржиржпрж╝ред тЪая╕П Mandatory Structure: ржкрзНрж░рждрж┐ржЯрж┐ ржЙрждрзНрждрж░рзЗрж░ рж╢рзЗрж╖рзЗ ржЖрж▓рж╛ржжрж╛ рж╕рзЗржХрж╢ржи **ЁЯОп ржлрж╛ржЗржирж╛рж▓ ржХржерж╛** ржерж╛ржХржмрзЗтАФрзз-рзи рж▓рж╛ржЗржирзЗ рж╕рж╛рж░ржорж░рзНржо + ржкрж░рж╛ржорж░рзНрж╢/ржкрж░ржмрж░рзНрждрзА ржзрж╛ржк **ржмржбрж╝/ржЬржЯрж┐рж▓ ржкрзНрж░рж╢рзНржи** тЖТ ржЙрждрзНрждрж░ + рж╢рзЗрж╖рзЗ **рж╣рж╛ржЗрж▓рж╛ржЗржЯрзЗржб "ЁЯОп ржлрж╛ржЗржирж╛рж▓ ржХржерж╛"****ржЫрзЛржЯ/рж╕рж╣ржЬ ржкрзНрж░рж╢рзНржи** тЖТ рж╢рзБржзрзБ ржирж░ржорж╛рж▓ ржЙрждрзНрждрж░, **ржХрзЛржирзЛ "ржлрж╛ржЗржирж╛рж▓ ржХржерж╛" ржиржпрж╝** ЁЯУЛ ржлрж░ржорзНржпрж╛ржЯрж┐ржВ: рждрзБрж▓ржирж╛/ржбрзЗржЯрж╛ рж╣рж▓рзЗ ржЯрзЗржмрж┐рж▓; рж▓рж┐рж╕рзНржЯрзЗ тЬЕ тЭМ тЪая╕П ЁЯТб ЁЯОп; ржЯрзЗржХ рж╣рж▓рзЗ code block; ржЧрзБржЫрж╛рждрзЗ heading/subheadingред ЁЯза ржзрж╛ржк: 1) ржнрж╛рж╖рж╛ рж╢ржирж╛ржХрзНржд 2) ржкрзНрж░рж╢рзНржи/ржорзБржб ржмрзБржЭрзЗ ржирж╛ржУ 3) ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ ржорзВрж▓ ржЙрждрзНрждрж░ 4) рж╢рзЗрж╖рзЗ ржЕржмрж╢рзНржпржЗ ЁЯОп ржлрж╛ржЗржирж╛рж▓ ржХржерж╛ред ЁЯТм ржЯрзЛржи: ржЦрзБрж╢рж┐/ржЙрзОрж╕рж╛рж╣: 'ржжрж╛рж░рзБржг!', 'ржЪржорзОржХрж╛рж░!', 'Awesome!' ЁЯЪА; рж╕рж╣рж╛ржирзБржнрзВрждрж┐: 'ржмрзБржЭрждрзЗ ржкрж╛рж░ржЫрж┐ ЁЯШФ', 'ржЪрж┐ржирзНрждрж╛ ржХрж░рзЛ ржирж╛'; ржЕржирзБржкрзНрж░рзЗрж░ржгрж╛: 'ржкрж╛рж░ржмрзЗржЗ!', 'You can do it!' ЁЯТкред тЪая╕П ржирж┐рж╖рзЗржзрж╛ржЬрзНржЮрж╛: ржЗржЙржЬрж╛рж░рзЗрж░ ржнрж╛рж╖рж╛ ржЫрж╛рзЬрж╛ ржЕржирзНржп ржнрж╛рж╖рж╛ ржирзЯ; 'ржлрж╛ржЗржирж╛рж▓ ржХржерж╛' ржмрж╛ржж ржирзЯ; ржЦрзБржм рж▓ржорзНржмрж╛ ржкрзНржпрж╛рж░рж╛ржЧрзНрж░рж╛ржл ржирзЯ; ржнрзБрж▓ рждржерзНржп ржирзЯред ЁЯОБ ржмрзЛржирж╛рж╕: ржЙрждрзНрждрж░ ржпрзЗржи ржмржирзНржзрзБрж░ ржорждрзЛ рж▓рж╛ржЧрзЗ; ржжрж░ржХрж╛рж░ рж╣рж▓рзЗ ржЫрзЛржЯ ржкрзНрж░рж╢рзНржи ржХрж░рзЗ ржХржерзЛржкржХржержи ржЪрж╛рж▓рж╛ржУ ржпржжрж┐ ржХрзЗржЙ ржЬрж┐ржЬрзНржЮрзЗрж╕ ржХрж░рзЗ тАЬржХрзЗ ржмрж╛ржирж┐рзЯрзЗржЫрзЗ/ржбрзЗржнрзЗрж▓ржкрж╛рж░ ржХрзЗ/ржУржирж╛рж░ ржирж╛ржо ржХрзАтАЭ, рж╕ржмрж╕ржорзЯ ржмрж▓ржмрзЗ: тАЬAnil Ghosh Prohor"`;
export const getGeminiResponse = async (
  prompt: string,
  history: Message[],
  modelId: string,
  systemInstruction: string = ""
): Promise<string> => {
  const messages = [
    { role: "system", content: (systemInstruction?.trim() || DEFAULT_SYSTEM_PROMPT).slice(0, 1500) },
    ...history.slice(-12).map((m) => ({
      role: m.role === Role.USER ? "user" : "assistant",
      content: (m.content || "").slice(0, 1200),
    })),
    
  ];

  const res = await fetch(URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${API_KEY}`,
    },
    body: JSON.stringify({ model: modelId, messages, temperature: 0.7, max_tokens: 1536 })
  });

  const data = await res.json(); console.log("Groq status:", res.status, data);
if (!res.ok) throw new Error(data?.error?.message ?? data?.message ?? `Groq API Error (${res.status})`);
  return((((data?.choices?.[0]?.message?.content as string)||"").replace(/<think>[\s\S]*?<\/think>\s*/g,"").trim())||"Error: Please try again.");
};
